{% extends 'base.html' %}

{% block title %}SkyBooking - Your Journey Begins Here{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container">
            <div class="row min-vh-100 align-items-center">
                <div class="col-lg-6">
                    <div class="hero-content">
                        <h1 class="display-2 fw-bold mb-4 text-white">
                            Discover Your
                            <span class="text-warning">Dream Destination</span>
                        </h1>
                        <p class="lead mb-5 text-white">
                            Experience seamless travel with our premium flight booking service.
                        </p>
                    </div>
                </div>
                <div class="col-lg-6">
                    <!-- Search Card -->
                    <div class="search-card bg-white p-4 rounded-3 shadow">
                        <h3 class="mb-4 text-primary"><i class="fas fa-plane-departure me-2"></i>Book Your Flight</h3>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label text-dark fw-bold">From</label>
                                <div class="position-relative">
                                    <input type="text" id="origin" class="form-control form-control-lg" 
                                           placeholder="Departure city" value="{{ origin }}" autocomplete="off"
                                           style="color: #000 !important; background: #fff !important;">
                                    <div id="originSuggestions" class="suggestions-dropdown"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-dark fw-bold">To</label>
                                <div class="position-relative">
                                    <input type="text" id="destination" class="form-control form-control-lg" 
                                           placeholder="Destination city" value="{{ destination }}" autocomplete="off"
                                           style="color: #000 !important; background: #fff !important;">
                                    <div id="destinationSuggestions" class="suggestions-dropdown"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-dark fw-bold">Departure Date</label>
                                <input type="text" id="date" class="form-control form-control-lg" 
                                       placeholder="Select date" value="{{ date }}" readonly
                                       style="color: #000 !important; background: #fff !important; cursor: pointer;">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-dark fw-bold">Passengers</label>
                                <select id="passengers" class="form-select form-select-lg"
                                        style="color: #000 !important; background: #fff !important;">
                                    <option value="1" {% if passengers == '1' %}selected{% endif %}>1 Person</option>
                                    <option value="2" {% if passengers == '2' %}selected{% endif %}>2 Persons</option>
                                    <option value="3" {% if passengers == '3' %}selected{% endif %}>3 Persons</option>
                                    <option value="4" {% if passengers == '4' %}selected{% endif %}>4 Persons</option>
                                    <option value="5" {% if passengers == '5' %}selected{% endif %}>5 Persons</option>
                                    <option value="6" {% if passengers == '6' %}selected{% endif %}>6+ Persons</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <div class="d-flex gap-3">
                                    <button type="button" id="searchFlights" class="btn btn-primary btn-lg flex-fill">
                                        <i class="fas fa-search me-2"></i>Search Flights
                                    </button>
                                    <button type="button" id="clearSearch" class="btn btn-outline-secondary btn-lg">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="flightResults" class="py-5">
        {% if flights %}
        <div class="container">
            <h3 class="fw-bold mb-4 text-dark"><i class="fas fa-plane me-2"></i>Available Flights</h3>
            <div class="row g-4">
                {% for flight in flights %}
                <div class="col-xl-4 col-lg-6">
                    <div class="card h-100 shadow">
                        <div class="card-header bg-primary text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-plane me-2"></i>{{ flight.code }}
                                </div>
                                <div class="text-end">
                                    <div class="h5 mb-0">${{ flight.price }}</div>
                                    <small>per person</small>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="text-center">
                                    <div class="fw-bold text-primary">{{ flight.origin }}</div>
                                    <div class="text-muted">{{ flight.departure_time|date:"H:i" }}</div>
                                </div>
                                <div class="text-center">
                                    <i class="fas fa-plane text-muted"></i>
                                </div>
                                <div class="text-center">
                                    <div class="fw-bold text-success">{{ flight.destination }}</div>
                                    <div class="text-muted">{{ flight.arrival_time|date:"H:i" }}</div>
                                </div>
                            </div>
                            <div class="text-center mb-3">
                                <small class="text-muted">{{ flight.departure_time|date:"M d, Y" }}</small>
                            </div>
                            <div class="d-flex justify-content-between text-sm">
                                <span class="text-success">{{ flight.available_seats_count }} available</span>
                                <span class="text-muted">{{ flight.aircraft_type }}</span>
                            </div>
                        </div>
                        <div class="card-footer">
                            <a href="{% url 'flight-seats-gui' flight.id %}" class="btn btn-primary w-100">
                                Select Seats <i class="fas fa-arrow-right ms-2"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
.hero-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

.suggestions-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.suggestion-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    color: #333 !important;
}

.suggestion-item:hover {
    background: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none;
}

/* Force text colors */
input, select, option {
    color: #000 !important;
}

input::placeholder {
    color: #666 !important;
}
</style>

<script>
// Cache buster: 2026-01-01-20:15
$(document).ready(function() {
    console.log('Page loaded, initializing...');
    
    // Initialize datepicker
    $('#date').datepicker({
        format: 'yyyy-mm-dd',
        startDate: new Date(),
        autoclose: true,
        todayHighlight: true
    });
    
    // Origin input events
    $('#origin').on('input', function() {
        const query = $(this).val();
        console.log('Origin input:', query);
        if (query.length >= 1) {
            fetchSuggestions(query, 'origin');
        } else {
            fetchSuggestions('', 'origin');
        }
    }).on('focus', function() {
        console.log('Origin focused');
        fetchSuggestions('', 'origin');
    });
    
    // Destination input events
    $('#destination').on('input', function() {
        const query = $(this).val();
        console.log('Destination input:', query);
        if (query.length >= 1) {
            fetchSuggestions(query, 'destination');
        } else {
            fetchSuggestions('', 'destination');
        }
    }).on('focus', function() {
        console.log('Destination focused');
        fetchSuggestions('', 'destination');
    });
    
    // Search button
    $('#searchFlights').on('click', function() {
        console.log('Search clicked');
        performSearch();
    });
    
    // Clear button
    $('#clearSearch').on('click', function() {
        console.log('Clear clicked');
        $('#origin').val('');
        $('#destination').val('');
        $('#date').val('');
        $('#passengers').val('1');
        $('#originSuggestions').hide();
        $('#destinationSuggestions').hide();
        $('#flightResults').html('');
    });
    
    // Auto-search on field changes
    $('#date, #passengers').on('change', function() {
        console.log('Field changed, auto-searching');
        performSearch();
    });
});

function fetchSuggestions(query, field) {
    console.log('Fetching suggestions:', query, field);
    
    const url = query.length === 0 ? 
        `/api/cities/?field=${field}&all=true` : 
        `/api/cities/?q=${encodeURIComponent(query)}&field=${field}`;
    
    $.get(url)
        .done(function(data) {
            console.log('Suggestions received:', data);
            showSuggestions(field, data.suggestions || []);
        })
        .fail(function(xhr) {
            console.error('Suggestion error:', xhr.responseText);
        });
}

function showSuggestions(field, suggestions) {
    const dropdown = $(`#${field}Suggestions`);
    dropdown.empty();
    
    if (suggestions.length === 0) {
        dropdown.hide();
        return;
    }
    
    suggestions.forEach(function(city) {
        const item = $('<div class="suggestion-item"></div>')
            .text(city)
            .on('click', function() {
                $(`#${field}`).val(city);
                dropdown.hide();
                performSearch();
            });
        dropdown.append(item);
    });
    
    dropdown.show();
}

function performSearch() {
    const origin = $('#origin').val();
    const destination = $('#destination').val();
    const date = $('#date').val();
    const passengers = $('#passengers').val();
    
    console.log('Searching:', { origin, destination, date, passengers });
    
    const params = new URLSearchParams();
    if (origin) params.append('origin', origin);
    if (destination) params.append('destination', destination);
    if (date) params.append('date', date);
    if (passengers) params.append('passengers', passengers);
    
    $.get(`/?${params.toString()}`, { 'X-Requested-With': 'XMLHttpRequest' })
        .done(function(html) {
            console.log('Search completed');
            const newResults = $(html).find('#flightResults').html();
            $('#flightResults').html(newResults);
        })
        .fail(function(xhr) {
            console.error('Search error:', xhr.responseText);
        });
}

// Hide suggestions when clicking outside
$(document).on('click', function(e) {
    if (!$(e.target).closest('.position-relative').length) {
        $('.suggestions-dropdown').hide();
    }
});
</script>
{% endblock %}